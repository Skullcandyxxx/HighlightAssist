name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows-installer:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
    
    - name: Create installer images (placeholder)
      run: |
        # Create simple BMP placeholder images for the installer wizard so ISCC won't fail when packaging
        Write-Host "Generating placeholder wizard images..."
        Add-Type -AssemblyName System.Drawing
        $root = Get-Location
        $imgPath = Join-Path $root 'installer-wizard-image.bmp'
        $imgSmallPath = Join-Path $root 'installer-wizard-small.bmp'

        # Large image (164x314)
        $bmp = New-Object System.Drawing.Bitmap 164,314
        $g = [System.Drawing.Graphics]::FromImage($bmp)
        $g.Clear([System.Drawing.Color]::FromArgb(124,58,237))
        # Draw a simple title to make it non-empty
        try {
          $font = New-Object System.Drawing.Font('Segoe UI',18)
          $brush = [System.Drawing.Brushes]::White
          $g.DrawString('HighlightAssist', $font, $brush, 8, 130)
        } catch { }
        $bmp.Save($imgPath, [System.Drawing.Imaging.ImageFormat]::Bmp)
        $g.Dispose()
        $bmp.Dispose()

        # Small image (55x58)
        $bmp2 = New-Object System.Drawing.Bitmap 55,58
        $g2 = [System.Drawing.Graphics]::FromImage($bmp2)
        $g2.Clear([System.Drawing.Color]::FromArgb(16,185,129))
        $bmp2.Save($imgSmallPath, [System.Drawing.Imaging.ImageFormat]::Bmp)
        $g2.Dispose()
        $bmp2.Dispose()
        Write-Host "Placeholder images created: $imgPath, $imgSmallPath"
    
    - name: Build installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer-config.iss
        # Find the generated .exe (assuming output in project root or Output/)
        $exe = Get-ChildItem -Path . -Filter "HighlightAssist-Setup-v*.exe" -Recurse | Select-Object -First 1
        $installersDir = Join-Path (Get-Location) 'installers'
        if (-not (Test-Path $installersDir)) {
          New-Item -ItemType Directory -Force -Path $installersDir | Out-Null
        }
        if ($exe) {
          $installersFullPath = (Get-Item $installersDir).FullName
          if ($exe.Directory.FullName -eq $installersFullPath) {
            Write-Host "Installer already located in installers/, skipping copy."
          } else {
            Copy-Item $exe.FullName $installersDir -Force
          }
        } else {
          Write-Host "No installer EXE found - continuing and attaching available script installers." -ForegroundColor Yellow
          # Do not exit the workflow; allow scripts to be generated and release to be created.
        }

    - name: Build cross-platform installers (scripts)
      run: |
        Write-Host "Running build-installers.ps1 to generate bat/sh installers..."
        pwsh -NoProfile -ExecutionPolicy Bypass -Command "./build-installers.ps1"

    - name: "Debug - list installers folder"
      run: |
        Write-Host "Contents of installers/"
        Get-ChildItem -Path installers -Recurse | Format-Table -AutoSize
    
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: HighlightAssist-Installer
        path: installers/**
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        # Attach any installers present in the installers/ directory. This is tolerant if the .exe is not produced.
        files: |
          installers/**
        body: |
          ## HighlightAssist v${{ github.ref_name }}
          
          ### ü™ü Windows Installation
          
          **Recommended:** Download `HighlightAssist-Setup-v*.exe` for a professional installer with:
          - ‚úÖ Python dependency check
          - ‚úÖ Automatic dependency installation
          - ‚úÖ Start menu shortcuts
          - ‚úÖ Auto-start on Windows boot
          - ‚úÖ Easy uninstall
          
          **Alternative:** Use `HighlightAssist-Setup-Windows.bat` for manual installation
          
          ### üêß Linux Installation
          
          Download and run `HighlightAssist-Setup-Linux.sh`:
          ```bash
          chmod +x HighlightAssist-Setup-Linux.sh
          ./HighlightAssist-Setup-Linux.sh
          ```
          
          ### üçé macOS Installation
          
          Download and run `HighlightAssist-Setup-macOS.sh`:
          ```bash
          chmod +x HighlightAssist-Setup-macOS.sh
          ./HighlightAssist-Setup-macOS.sh
          ```
          
          ---
          
          **What's New:**
          - Professional Windows installer (.exe)
          - Cross-platform installers for Linux and macOS
          - Animated setup wizard in extension
          - Enhanced error handling and logging
          
          **System Requirements:**
          - Python 3.8 or higher
          - Modern web browser (Chrome, Firefox, Edge, Opera, Brave)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
